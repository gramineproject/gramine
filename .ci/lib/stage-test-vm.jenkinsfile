stage('test') {
    // prepare files to pass current work dir and envvars into VM
    sh '''
        mkdir -p $HOME/files_for_vm
        echo $PWD > $HOME/files_for_vm/pwd

        touch $HOME/files_for_vm/envs
        echo "export SGX=$SGX" >> $HOME/files_for_vm/envs
        echo "export IS_VM=$IS_VM" >> $HOME/files_for_vm/envs

        echo "export PATH=\"$PATH\"" >> $HOME/files_for_vm/envs
        echo "export PKG_CONFIG_PATH=\"$PKG_CONFIG_PATH\"" >> $HOME/files_for_vm/envs
        echo "export PYTHONPATH=\"$PYTHONPATH\"" >> $HOME/files_for_vm/envs
        echo "export GRAMINE_PKGLIBDIR=\"$GRAMINE_PKGLIBDIR\"" >> $HOME/files_for_vm/envs
        echo "export XDG_CONFIG_HOME=\"$XDG_CONFIG_HOME\"" >> $HOME/files_for_vm/envs

        // TODO: I don't care about this, but maybe should keep?
        echo "export CARGO_HOME=\"$CARGO_HOME\"" >> $HOME/files_for_vm/envs
    '''

    timeout(time: 15, unit: 'MINUTES') {
        sh '''
            cd device-testing-tools/initramfs_builder
            ./run.sh | tee OUTPUT
            grep "TESTS OK" OUTPUT
        '''
    }
}
