stage('test') {
    // prepare files to pass current work dir and envvars into VM
    sh '''
        mkdir -p /opt/files_for_vm
        echo $PWD > /opt/files_for_vm/pwd

        touch /opt/files_for_vm/envs
        echo "export SGX=$SGX" >> /opt/files_for_vm/envs
        echo "export IS_VM=$IS_VM" >> /opt/files_for_vm/envs

        echo "export PATH=\"$PATH\"" >> /opt/files_for_vm/envs
        echo "export PKG_CONFIG_PATH=\"$PKG_CONFIG_PATH\"" >> /opt/files_for_vm/envs
        echo "export PYTHONPATH=\"$PYTHONPATH\"" >> /opt/files_for_vm/envs
        echo "export GRAMINE_PKGLIBDIR=\"$GRAMINE_PKGLIBDIR\"" >> /opt/files_for_vm/envs

        // TODO: Do we care about these?
        echo "export XDG_CONFIG_HOME=\"$XDG_CONFIG_HOME\"" >> /opt/files_for_vm/envs
        echo "export CARGO_HOME=\"$CARGO_HOME\"" >> /opt/files_for_vm/envs
    '''

    timeout(time: 15, unit: 'MINUTES') {
        sh '''
            cd device-testing-tools/initramfs_builder
            ./run.sh
        '''
    }
}
